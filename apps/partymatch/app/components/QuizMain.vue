<template>
	<div class="relative flex h-full flex-col">
		<!-- Progress bar -->
		<div class="section w-full py-8">
			<div
				:style="{
					width: `${((currentQuestionIndex + 1) / questions.length) * 100}%`,
				}"
				class="bg-green-2 h-1 rounded transition-all duration-300"
			></div>
		</div>

		<!-- Question -->
		<div class="section flex flex-row">
			<img src="/img/card-side.png" class="scale-x-[-1] transform py-4" />
			<div
				class="relative flex h-90 flex-col gap-4 overflow-auto rounded-2xl bg-white px-8 py-6 text-center shadow-md [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden"
				ref="descriptionContainer"
			>
				<div ref="innerContent">
					<h2 class="text-h8 font-kondolar font-bold">
						{{ currentQuestion.title }}
					</h2>
					<p v-if="currentQuestion.title_full">
						ชื่อเต็ม: {{ currentQuestion.title_full }}
					</p>
					<h3 class="font-bold" v-if="currentQuestion.description">
						รายละเอียด
					</h3>
					<p v-html="renderMarkdown(currentQuestion.description)"></p>
				</div>
				<div
					v-if="isOverflowing"
					class="0% 25% 100% sticky -bottom-6 flex h-14 w-full shrink-0 items-center justify-center bg-linear-to-t from-white via-white to-transparent"
				>
					<img src="/img/chevron-down.svg" class="h-6" />
				</div>
			</div>
			<img src="/img/card-side.png" class="py-4" />
		</div>

		<!-- Choices -->
		<div class="section flex w-full flex-col gap-4 pt-4">
			<div class="h-12 text-center">
				<p v-if="selectedPartyId" class="font-sriracha text-b2">
					{{ resultMessage }}
				</p>
				<p v-else-if="hasClicked" class="font-sriracha text-b2">Your Answer</p>
				<p v-if="explainMessage && selectedPartyId" class="text-b6">
					เพราะพรรคนี้ {{ explainMessage }}
				</p>
			</div>
			<div class="flex justify-between px-20">
				<QuizChoices
					v-for="choice in choiceConfigs"
					:key="choice.label"
					v-bind="choice"
					:logoSrc="partyLogo"
					:selected="selectedAnswer === choice.label"
					:isUnselected="selectedAnswer && selectedAnswer !== choice.label"
					:isMatch="
						selectedAnswer === choice.label && isAnswerMatch(choice.label)
					"
					:showPartyLogo="hasClicked && isAnswerMatch(choice.label)"
					:disabled="!!selectedAnswer"
					@click="handleChoiceClick(choice.label)"
				/>
			</div>
		</div>

		<!-- Navigation -->
		<div
			class="font-kondolar items center absolute bottom-0 z-0 flex h-20 w-full flex-row justify-between p-6"
		>
			<div class="h-8 w-40">
				<button
					v-if="currentQuestionIndex > 0"
					class="flex cursor-pointer items-center gap-2 self-center hover:font-bold"
					@click="currentQuestionIndex--"
				>
					<img :src="arrowNext" class="h-8 scale-x-[-1]" /> กลับ
				</button>
			</div>

			<button
				v-if="
					selectedPartyId &&
					hasClicked &&
					explainMessage !== 'ยังไม่มีชื่อตอนโหวต'
				"
				class="hover:bg-gray-3 mx-auto cursor-pointer self-center rounded-full border-3 bg-white px-4 py-2 font-bold"
				@click="showPartyResult = true"
			>
				ดูผลลงมติพรรค
			</button>

			<button
				class="flex h-8 w-40 items-center justify-end gap-2 self-center pr-0"
				:class="{
					'font-bold': isLastQuestion,
					'cursor-not-allowed opacity-50': !hasClicked,
					'cursor-pointer hover:font-bold': hasClicked,
				}"
				:disabled="!hasClicked"
				@click="handleNextClick"
			>
				{{ isLastQuestion ? 'ดูผลลัพธ์' : 'ไปต่อ' }}
				<img :src="isLastQuestion ? heartIcon : arrowNext" class="h-8" />
			</button>
		</div>

		<!-- Party Result Popup -->
		<PartyResult
			v-if="showPartyResult"
			class="absolute"
			:billTitle="currentQuestion.title"
			:partyLogo="partyLogo"
			:partyName="partyName"
			:partyCount="currentPartyAnswer?.party_count"
			:result="partyAnswerLabel"
			:resultPct="partyAnswerPct"
			:votes="partyVotes"
			@click="handleClose"
		/>
	</div>
</template>

<script setup>
import { marked } from 'marked';
import QuizChoices from './QuizChoice.vue';
import PartyResult from './PartyVotes.vue';
import arrowNext from '~/assets/images/arrow-next.svg';
import heartIcon from '~/assets/images/heart-icon.svg';

const props = defineProps({
	questions: Array,
	partyAnswers: Array,
	selectedPartyId: String,
	partyLogo: String,
	partyName: String,
});

const emit = defineEmits(['show-result']);

const currentQuestionIndex = ref(0);
const selectedAnswer = ref(null);
const hasClicked = ref(false);
const resultMessage = ref('');
const explainMessage = ref('');
const userAnswers = ref([]);

// --- Computed ---
const currentQuestion = computed(
	() => props.questions[currentQuestionIndex.value] || {},
);
const isLastQuestion = computed(
	() => currentQuestionIndex.value === props.questions.length - 1,
);
const currentPartyAnswer = computed(() => {
	return props.partyAnswers?.find(
		(a) =>
			a.party_id === props.selectedPartyId &&
			a.quiz_id === currentQuestion.value.id,
	);
});

const partyVotes = computed(() => {
	if (!currentPartyAnswer.value) return [];
	return [
		{
			label: 'เห็นด้วย',
			count: currentPartyAnswer.value.agree_count,
			color: '#1AD39E',
		},
		{
			label: 'ไม่เห็นด้วย',
			count: currentPartyAnswer.value.disagree_count,
			color: 'var(--red-2)',
		},
		{
			label: 'งดออกเสียง',
			count: currentPartyAnswer.value.abstain_count,
			color: '#9D9D9D',
		},
		{
			label: 'ลา/ขาด',
			count: currentPartyAnswer.value.absent_count,
			color: 'white',
			border: '1px solid gray',
		},
	];
});

const partyAnswerPct = computed(() => {
	if (!currentPartyAnswer.value || !currentPartyAnswer.value.party_count)
		return 0;

	const matchingVote = partyVotes.value.find(
		(vote) => vote.label === partyAnswerLabel.value,
	);

	const matchingCount = matchingVote ? matchingVote.count : 0;
	const totalCount = currentPartyAnswer.value.party_count;

	return parseFloat(((matchingCount / totalCount) * 100).toFixed(0));
});

const choiceConfigs = [
	{
		label: 'งดออกเสียง',
		iconSvg: `<svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M57.4219 35.876C56.4754 35.4223 55.4284 35.2826 54.375 35.5412L53.5715 35.7421L52.7511 35.943C52.5276 35.997 52.3135 36.0051 52.0982 35.9597L51.2947 35.7756L50.4911 35.6082L49.6206 35.5245C48.7662 35.5327 47.9708 35.8227 47.2768 36.2778L46.4732 36.7968L45.8203 37.2321L45.2511 36.9809L44.4308 36.6461C43.6748 36.3319 42.8846 36.143 42.0703 36.1104L40.4632 36.0434C39.646 36.0107 38.8406 36.141 38.0692 36.4117L37.2824 36.6796L36.4956 36.9642C36.1659 37.08 35.8382 37.1363 35.5246 37.1484L34.721 37.1818L33.9174 37.1986C33.5985 37.2103 33.2628 37.1871 32.913 37.0981L32.1094 36.8805L31.2891 36.6796C30.446 36.4655 29.584 36.4396 28.7277 36.6126L27.9241 36.7801L27.1373 36.9307C26.4548 37.0688 25.7822 37.2874 25.1284 37.5669L24.3415 37.9017L23.5212 38.2365L21.8806 37.6338C20.7673 37.2284 19.5027 37.3446 18.365 37.5836L17.0759 37.8515H17.0592C17.033 37.8526 17.0014 37.8829 16.9755 37.885L16.8415 37.9017L16.8583 37.9184C15.7738 38.0654 14.9527 38.9798 15 40.0948C15.0521 41.273 16.0485 42.1834 17.2266 42.1372H17.3773L17.5614 42.1205L17.7288 42.087L19.2523 41.7689C19.6611 41.6832 19.9628 41.6538 20.173 41.6517C20.3041 41.6505 20.3784 41.6632 20.4074 41.6684L21.2277 41.9698L22.048 42.2544C23.097 42.6379 24.1952 42.6282 25.2288 42.1874L26.0156 41.8359L26.8192 41.501C27.2146 41.3326 27.5987 41.2092 27.9744 41.1327L28.7779 40.9821L29.5815 40.8147C29.7854 40.7741 29.9953 40.7707 30.2344 40.8314L31.0547 41.049L31.8583 41.2499C32.5899 41.4359 33.3363 41.5128 34.0848 41.4843L34.8884 41.4508L35.692 41.4341C36.4492 41.4049 37.1998 41.2513 37.9186 40.9988L38.7054 40.7309L39.4922 40.4463C39.7645 40.3516 40.0222 40.3195 40.279 40.3292L41.9029 40.3961C42.1665 40.4069 42.4604 40.4599 42.7902 40.597L43.6105 40.9318L44.4141 41.2667C45.6738 41.7904 46.9614 41.5993 48.0302 40.8984L48.8337 40.3794L49.6206 39.8604C49.6416 39.8466 49.6568 39.8178 49.6708 39.8102L50.4241 39.9776L51.2277 40.145C52.0804 40.3237 52.9441 40.3033 53.7891 40.0948L54.5927 39.8939L55.3962 39.7097C55.4231 39.7031 55.4392 39.6922 55.4465 39.693C55.4602 39.695 55.4974 39.7115 55.5636 39.7432L57.1708 40.5133C58.0353 40.9265 58.9874 41.1025 59.9665 40.9821L60.7701 40.8816L60.8538 40.8649L64.1183 40.8984H64.269C65.2075 40.9058 65.9649 40.2973 66.2612 39.4586L66.3784 39.3247L66.4453 38.7722L66.4621 38.6551C66.5138 38.2005 66.4202 37.6942 66.144 37.2488C65.8888 36.8387 65.5535 36.6041 65.3237 36.4787C64.9191 36.2582 64.5354 36.2241 64.3959 36.2117L64.3862 36.2109L63.5156 36.2276L62.9632 36.2946L62.4107 36.3783C62.0378 36.4237 61.5744 36.463 61.038 36.5289L59.4308 36.7298C59.3408 36.7403 59.2115 36.7416 59.0123 36.6461L58.2255 36.2611L57.4219 35.876Z" fill="white"/>
</svg>
`,
		buttonClass: 'bg-[#BFBFBF] focus:bg-gray-2',
		showInfoIcon: true,
	},
	{
		label: 'เห็นด้วย',
		iconSvg: `<svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M55.6864 15.3306C56.0582 15.365 56.4085 15.459 56.7243 15.5985L57.5781 16.1342L58.8839 17.2391C59.4931 17.7507 60.0171 18.3517 60.4241 19.0304L60.8426 19.7168L61.2611 20.4199C61.4834 20.7899 61.7272 21.1425 61.9977 21.4746L62.5167 22.1108L63.0189 22.7302C63.6974 23.5617 64.0267 24.5605 63.9732 25.6264L63.923 26.4299L63.8895 27.2503C63.8393 28.2452 63.4837 29.1458 62.9185 29.9288L62.3995 30.6654L62.0312 31.1342L62.3326 31.8708L62.7009 32.7916C62.9451 33.4003 63.0717 34.1366 62.885 34.9177C62.6942 35.7099 62.2308 36.3266 61.7131 36.7592L60.9765 37.3619L60.2567 37.9813C60.0392 38.163 60.0056 38.2659 60.0056 38.2659L59.6038 39.8061C59.5511 40.0129 59.5381 40.3012 59.587 40.6933L59.7042 41.6308L59.8047 42.5516C59.9269 43.5318 59.8056 44.5266 59.3359 45.4478L58.9676 46.1677L58.5993 46.9043C58.1514 47.7823 57.4681 48.4602 56.6573 48.9634L55.8705 49.4489L55.0837 49.9512C54.9969 50.0055 54.9577 50.042 54.9497 50.0516V50.0683L54.6819 50.8384L54.4308 51.6253C54.2065 52.3028 53.9036 52.9487 53.5268 53.5505L53.1082 54.2201L52.673 54.9065C52.3209 55.4686 51.9138 56.005 51.4676 56.4969L50.9319 57.0828L50.3962 57.6855C50.0191 58.1012 49.6289 58.5073 49.241 58.9076L48.6886 59.4768L48.1361 60.0628C47.7225 60.4897 47.2793 60.8941 46.8303 61.2849L46.2277 61.8206L45.625 62.3395C44.9365 62.9386 43.7681 63.5658 42.3939 63.0929L41.875 62.9255L41.356 62.7413C41.2049 62.6893 40.8358 62.5675 40.5189 62.3563C40.4266 62.2947 40.2372 62.156 40.0502 61.9378C39.9817 61.8575 39.8822 61.7097 39.7823 61.5192L39.1127 61.1844C38.2265 60.7513 37.5315 60.0886 37.0368 59.2592L36.5848 58.5058L36.1495 57.7692C36.1391 57.7517 36.1197 57.7402 36.116 57.7358H36.1328C36.1328 57.7358 36.119 57.7249 36.0993 57.719L35.279 57.4846L34.4587 57.2335C33.7656 57.0258 33.1029 56.746 32.4832 56.3965L31.7801 55.9947L31.0602 55.5929C30.2847 55.1548 29.6426 54.556 29.1518 53.8183L28.2143 52.4121C27.9984 52.0877 27.7682 51.8074 27.5111 51.575L26.9085 51.0393L26.3225 50.5036C26.0546 50.2617 25.7371 50.0436 25.385 49.8507L23.9118 49.0471C23.1426 48.6257 22.4958 48.0404 21.9866 47.3228L21.5011 46.6532L21.0323 45.9835C20.5275 45.2715 20.1921 44.4758 20.0279 43.623L19.8605 42.7692L19.7265 42.0159L18.923 41.5471L18.0859 41.0784C16.9578 40.435 16.1861 39.3398 16.1439 37.9311L16.1272 37.0605L16.0937 36.19C16.0793 35.7072 16.0401 35.2311 15.9598 34.767L15.8091 33.9299L15.6585 33.0762C15.4543 31.8968 15.7624 30.7725 16.462 29.8451L16.9977 29.1253L17.5502 28.4054C17.7308 28.1642 17.8055 27.964 17.8348 27.8027L17.9855 27.0159L18.1194 26.2123C18.2433 25.5331 18.4395 24.8676 18.7053 24.2201L19.0234 23.45L19.3582 22.6632C19.7173 21.7924 20.2837 21.062 20.9989 20.4701L22.4051 19.2983L23.2924 18.7458C23.6141 18.6061 23.9671 18.5101 24.3471 18.4779C24.7219 18.4469 25.0852 18.4841 25.4185 18.5616L26.356 18.9132L27.2265 19.3652L27.9297 19.7168L28.5993 19.3485L29.4531 18.8462C30.0063 18.5241 30.7043 18.2861 31.4955 18.344C31.8977 18.374 32.2693 18.4774 32.6004 18.6286L33.4877 19.2145L34.8605 20.4199C35.2251 20.7431 35.5955 21.0152 35.9486 21.2235L36.6685 21.642L37.3884 22.0773C38.2035 22.5594 38.7606 23.2565 39.0625 24.0695L39.2801 24.9233L39.414 25.8273L39.4977 26.4132L40.2176 26.6978L40.3013 26.7313L40.4185 25.9779L40.5357 25.1744C40.6787 24.1556 41.135 23.2651 41.8248 22.546L42.4274 21.9099L43.0468 21.2737C43.2082 21.1042 43.271 20.9706 43.298 20.8552L43.6663 19.2815L43.9676 18.4445C44.3505 17.6677 44.9868 17.0557 45.8091 16.6866L46.5457 16.3518L47.2991 16.017L48.0859 15.7659C48.8878 15.5857 49.7033 15.6546 50.4799 15.95L51.2835 16.2514L52.0201 16.5527L52.0535 16.536L52.9073 16.1174L53.7611 15.7157L54.6484 15.3976C54.9737 15.3272 55.3217 15.2973 55.6864 15.3306ZM54.7823 19.9846L53.9285 20.3864C52.8861 20.892 51.7094 21.0081 50.5636 20.5706L49.76 20.2692L48.9732 19.9512L48.3035 20.2692L47.7678 20.5036L47.6506 21.0393L47.4665 21.8262C47.249 22.7585 46.7918 23.5782 46.1439 24.2536L45.5245 24.8898L44.9218 25.5259C44.8029 25.6508 44.7784 25.7255 44.7712 25.777L44.654 26.5806L44.5535 27.3842C44.4645 28.022 44.3322 28.6505 44.1518 29.2592L43.9174 30.0125L43.6998 30.7659C43.6551 30.9163 43.6025 31.0747 43.5491 31.2179C43.5123 31.3163 43.4202 31.5816 43.2477 31.8373C43.192 31.92 42.9038 32.3284 42.3605 32.5907C42.0302 32.7491 41.5449 32.8723 40.9877 32.7581C40.4396 32.6441 40.058 32.3509 39.8326 32.1052C39.4555 31.6935 39.3388 31.2501 39.3136 31.1509C39.2938 31.0732 39.2739 30.9979 39.2634 30.9333L38.6439 30.6989L37.7232 30.3306C36.4714 29.8376 35.5532 28.8254 35.3292 27.4009L35.0446 25.6599L34.4922 25.3418L33.7556 24.9065C33.1477 24.5472 32.5635 24.1208 32.0145 23.6342L31.3281 23.0315L31.1105 22.8306L30.7589 23.0483L29.9218 23.5337C28.7169 24.2355 27.3535 24.2602 26.1216 23.6174L25.2511 23.1654L24.7489 22.8976L24.4308 23.1822L23.7277 23.7681C23.4981 23.9581 23.3754 24.1426 23.3091 24.3038L22.673 25.844C22.5155 26.2269 22.4065 26.6079 22.3381 26.9824L22.1875 27.786L22.0535 28.5728C21.8907 29.4681 21.5049 30.2852 20.9654 31.0003L20.4297 31.7201L19.8772 32.4065L20.0279 33.1933L20.1785 34.0304C20.2936 34.6951 20.3588 35.3761 20.3794 36.0561L20.4129 36.9266V37.4791L21.0323 37.8306L21.8694 38.2994C22.9113 38.8923 23.6713 39.8458 23.9118 41.0951L24.0792 41.9489L24.2466 42.8195C24.3033 43.1085 24.4043 43.327 24.5312 43.5058L25 44.1755L25.4855 44.8451C25.6094 45.0189 25.7589 45.1641 25.971 45.2804L27.4442 46.084C28.075 46.4296 28.6585 46.8473 29.1852 47.3228L29.7879 47.8585L30.3739 48.3942C30.9102 48.8784 31.3919 49.4257 31.7968 50.0349L32.2489 50.738L32.7176 51.4411C32.8476 51.6366 32.9991 51.7634 33.1696 51.8596L33.8727 52.2614L34.5926 52.6632C34.92 52.8478 35.2785 53.0111 35.6808 53.132L36.5011 53.3663L37.3381 53.6174C38.4053 53.9383 39.266 54.6243 39.8326 55.5762L40.2678 56.3128L40.7198 57.0661C40.8145 57.224 40.9005 57.2904 40.9877 57.334L41.7243 57.7023L42.4609 58.0538C42.7069 58.1741 43.0362 58.3473 43.298 58.5393C43.32 58.5556 43.3374 58.5845 43.3649 58.6063L43.4152 58.5728L44.0178 58.0538C44.3751 57.7429 44.727 57.4221 45.0558 57.0828L45.6082 56.4969L46.1607 55.9277C46.5154 55.5616 46.8698 55.187 47.2154 54.8061L47.7511 54.2034L48.3035 53.6174C48.5801 53.3126 48.8229 52.9765 49.0402 52.6297L49.4754 51.9601L49.8939 51.2737C50.0856 50.9677 50.2441 50.6282 50.3627 50.2692L50.6138 49.4991L50.8817 48.7123C51.2323 47.6579 51.9333 46.8543 52.8236 46.3016L54.3973 45.3306C54.6332 45.1842 54.7353 45.0528 54.7823 44.9623L55.1506 44.2257L55.5189 43.5058C55.5433 43.4581 55.5842 43.3457 55.5524 43.0873L55.4352 42.1498L55.3348 41.2291C55.2298 40.3867 55.2552 39.5362 55.4687 38.7179L55.8705 37.1777C56.1383 36.1523 56.734 35.3189 57.4944 34.6833L58.231 34.0806L58.4989 33.8462L58.3482 33.4779L57.9799 32.5739C57.4903 31.3612 57.5701 30.0196 58.3984 28.8741L58.9174 28.1543L59.4531 27.4177C59.5816 27.2377 59.5995 27.1174 59.6038 27.0326L59.654 26.2291L59.6707 25.4087L59.1852 24.8061L58.683 24.1866C58.2784 23.6907 57.908 23.1633 57.5781 22.613L57.1596 21.9266L56.741 21.2235C56.5938 20.9798 56.4023 20.7422 56.1384 20.5204L55.4855 19.9679L55.2176 19.7503L54.7823 19.9846Z" fill="white"/>
</svg>
`,
		buttonClass: 'bg-[#1AD39E] focus:bg-green-1',
	},
	{
		label: 'ไม่เห็นด้วย',
		iconSvg: `<svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M19.7935 20.0446C20.5426 19.1596 21.8528 19.036 22.7552 19.7502L23.9592 20.4464C24.9685 21.0305 25.9852 21.8015 26.5373 22.8641L27.3381 24.407C27.3425 24.4154 27.3463 24.4218 27.3493 24.4266C27.3527 24.428 27.3567 24.4303 27.3618 24.4321L28.9829 25.0055C29.6561 25.2436 30.2942 25.5431 30.8914 25.9082L32.2809 26.7578C33.031 27.2164 33.6462 27.8293 34.1169 28.5672L35.0195 29.9832C35.2187 30.2955 35.4422 30.5565 35.6877 30.7742L36.8917 31.8401C37.136 32.0567 37.4172 32.2448 37.7455 32.4009L39.255 33.118C40.0038 33.474 40.6669 33.9613 41.2234 34.5772L41.4773 34.859C41.7379 34.7501 42.0066 34.6571 42.2809 34.5772L43.7109 34.1601L44.2187 32.5237C44.5427 31.478 45.192 30.545 46.2416 29.972L47.6785 29.1866C47.8613 29.0868 48.0066 28.9574 48.1305 28.7778L49.068 27.419C49.6805 26.5317 50.5465 25.9448 51.5513 25.6542L53.2407 25.166C53.3346 25.1388 53.4112 25.1122 53.4737 25.0906L53.8448 24.6191L54.1182 24.3875C55.0199 23.6213 56.3722 23.7303 57.1386 24.6316C57.8833 25.508 57.7984 26.8076 56.9656 27.5837L56.7787 27.8222L56.7494 27.8613L56.7173 27.8975L56.5108 28.1375C56.138 28.5707 55.6778 28.807 55.4171 28.9271C55.1082 29.0694 54.7683 29.1853 54.4307 29.2829L52.7413 29.7712C52.667 29.7926 52.6361 29.8131 52.6283 29.8186C52.6225 29.8227 52.6126 29.8297 52.5962 29.8535L51.6573 31.2123C51.1558 31.9388 50.508 32.5242 49.7321 32.9478L48.3482 33.7039C48.3396 33.7222 48.3262 33.7501 48.3133 33.7918L47.7469 35.6166C47.3666 36.844 46.4916 37.8143 45.1701 38.1989L43.895 38.5686L44.1573 39.2006L45.8468 39.534C46.871 39.7361 47.8211 40.2484 48.4849 41.1537L48.6132 41.3406L49.5117 42.719C49.6255 42.8936 49.7626 43.0221 49.9427 43.1249L51.3713 43.9397C52.2893 44.4637 52.945 45.2521 53.3412 46.1955L54.0276 47.8292C54.0985 47.9979 54.1612 48.0434 54.2033 48.0691L55.5887 48.9146L57.0019 49.7949L58.3802 50.6696C58.8693 50.9801 59.627 51.5154 60.0181 52.3381L60.1813 52.6813L60.2218 52.765L60.2538 52.8515L60.3348 53.0719C60.8865 53.872 60.8397 54.9725 60.159 55.724C59.3644 56.601 58.0101 56.6678 57.133 55.8733L57.027 55.7784L56.6406 55.4268L56.4578 54.9386L56.2667 54.4308L56.2541 54.4042C56.2108 54.3726 56.1544 54.3327 56.0825 54.2871L54.7056 53.4123C54.2569 53.1275 53.8062 52.8478 53.3551 52.5725L51.9698 51.7271C51.0885 51.189 50.4614 50.4075 50.0753 49.488L49.3903 47.8557C49.3294 47.7106 49.2804 47.6811 49.2466 47.6618L47.818 46.847C47.0463 46.4065 46.4074 45.8042 45.9221 45.0599L45.0683 43.7499C45.0546 43.7463 45.0373 43.7429 45.0167 43.7388L43.1431 43.3691C41.9351 43.1307 40.9183 42.4156 40.3724 41.2416L39.8772 42.027C39.4758 42.6634 38.9962 43.2344 38.436 43.729L37.2307 44.7935C36.6723 45.2865 36.0482 45.6919 35.3696 46.0142L33.8518 46.7354C33.6296 46.841 33.4678 46.9726 33.3384 47.1344L32.3228 48.4068C32.0819 48.708 31.8627 49.0488 31.6685 49.4349L30.8956 50.9709C30.391 51.9735 29.5676 52.6998 28.5211 53.0859L26.8973 53.6858C26.9309 53.6726 26.8712 53.6891 26.7215 53.8211C26.5671 53.9573 26.3613 54.1779 26.109 54.5131L25.1701 55.7589L25.053 55.9151L24.9093 56.0463L24.8046 56.1439C23.934 56.945 22.5787 56.8886 21.7773 56.0184C20.993 55.1661 21.0302 53.8496 21.8484 53.0426L22.6841 51.9349C23.3862 51.0021 24.2781 50.0832 25.4073 49.6665L27.0382 49.0652C27.0483 49.0615 27.0551 49.0566 27.0605 49.0541C27.0621 49.0511 27.0654 49.0484 27.0675 49.0443L27.8403 47.5083C28.161 46.871 28.5377 46.2759 28.9746 45.7296L29.9916 44.4587C30.54 43.7728 31.2234 43.2392 32.0131 42.8641L33.5309 42.1442C33.8643 41.9858 34.1496 41.7968 34.3945 41.5806L35.5984 40.5161C35.8413 40.3017 36.0602 40.047 36.2527 39.7419L37.1442 38.3286C37.3719 37.9676 37.6299 37.6323 37.9199 37.327C37.7776 37.1956 37.6126 37.0819 37.4148 36.988L35.9054 36.2709C35.2279 35.9488 34.6059 35.5415 34.0485 35.0474L32.8459 33.9815C32.2896 33.4884 31.8108 32.9201 31.4076 32.2879L30.5036 30.8719C30.3718 30.6653 30.2218 30.5219 30.046 30.4143L28.6565 29.5647C28.3278 29.3637 27.9619 29.1898 27.5544 29.0457L25.9333 28.4723C24.8747 28.098 24.0498 27.373 23.5351 26.3825L22.7343 24.8409C22.7551 24.8807 22.7336 24.8223 22.5753 24.6819C22.4199 24.5441 22.1752 24.366 21.8122 24.1559L20.2985 23.2798L20.1534 23.157L20.0446 23.0636C19.1413 22.299 19.0289 20.9479 19.7935 20.0446Z" fill="white"/>
</svg>
`,
		buttonClass: 'bg-[var(--red-2)] focus:bg-[var(--red-1)]',
	},
];

// --- Logic ---
const ANSWER_MAP = {
	abstain: { label: 'งดออกเสียง', matchKey: 'งดออกเสียง' },
	agree: { label: 'เห็นด้วย', matchKey: 'เห็นด้วย' },
	disagree: { label: 'ไม่เห็นด้วย', matchKey: 'ไม่เห็นด้วย' },
	'agree, disagree': {
		label: 'เสียงแตก',
		matchKey: ['เห็นด้วย', 'ไม่เห็นด้วย'],
	},
	absent: { label: 'ลา/ขาด', matchKey: null },
};

const partyAnswerLabel = computed(() => {
	const pAns = currentPartyAnswer.value?.party_answer;
	return ANSWER_MAP[pAns]?.label || 'ยังไม่มีชื่อตอนโหวต';
});

const isAnswerMatch = (label) => {
	const pAns = currentPartyAnswer.value?.party_answer;
	if (!pAns || !ANSWER_MAP[pAns]) return false;

	const matchKey = ANSWER_MAP[pAns].matchKey;

	return Array.isArray(matchKey)
		? matchKey.includes(label)
		: matchKey === label;
};

const handleChoiceClick = (label) => {
	if (selectedAnswer.value) return;
	selectedAnswer.value = label;
	hasClicked.value = true;

	userAnswers.value[currentQuestionIndex.value] = label;

	resultMessage.value = isAnswerMatch(label) ? "It's a match!" : 'Not match!';

	const statusMap = {
		absent: 'ไม่เข้าประชุมเกินครึ่ง',
		'agree, disagree': 'เสียงแตก',
		undefined: 'ยังไม่มีชื่อตอนโหวต',
	};
	explainMessage.value =
		statusMap[currentPartyAnswer.value?.party_answer] || '';
};

const handleNextClick = () => {
	if (!hasClicked.value) {
		return;
	}

	if (isLastQuestion.value) {
		emit('show-result', userAnswers.value);
	} else {
		currentQuestionIndex.value++;
	}
};

// --- UI/Overflow Logic ---
const descriptionContainer = ref(null);
const innerContent = ref(null);
const isOverflowing = ref(false);
const renderMarkdown = (markdownText) => marked.parse(markdownText || '');

const showPartyResult = ref(false);

const handleClose = () => {
	showPartyResult.value = false;
};

const checkOverflow = () => {
	if (descriptionContainer.value && innerContent.value) {
		isOverflowing.value =
			innerContent.value.scrollHeight > descriptionContainer.value.clientHeight;
	}
};

watch(currentQuestionIndex, (newIndex) => {
	const previousAnswer = userAnswers.value[newIndex];
	if (previousAnswer) {
		selectedAnswer.value = previousAnswer;
		hasClicked.value = true;
	} else {
		selectedAnswer.value = null;
		hasClicked.value = false;
		resultMessage.value = '';
		explainMessage.value = '';
	}
	nextTick(checkOverflow);
});

let observer;
onMounted(() => {
	observer = new ResizeObserver(checkOverflow);
	if (innerContent.value) observer.observe(innerContent.value);
});
onUnmounted(() => observer?.disconnect());
</script>
